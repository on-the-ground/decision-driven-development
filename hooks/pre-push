#!/bin/bash
# ============================================================================
# Pre-push hook for Decision-Driven Development Policy
# ============================================================================

set -euo pipefail

# Find and source DDD root detection library
# When installed as git hook, we need to find the actual DDD system location
if [[ -f "${HOME}/.local/share/ddd-system/lib/ddd_root.sh" ]]; then
    source "${HOME}/.local/share/ddd-system/lib/ddd_root.sh"
elif [[ -f "$(dirname "${BASH_SOURCE[0]}")/../lib/ddd_root.sh" ]]; then
    # Fallback for development environment
    source "$(dirname "${BASH_SOURCE[0]}")/../lib/ddd_root.sh"
else
    echo "‚ùå ERROR: Cannot find ddd_root.sh" >&2
    echo "Expected at: ${HOME}/.local/share/ddd-system/lib/ddd_root.sh" >&2
    exit 1
fi

# Find the DDD system root
DDD_ROOT=$(find_ddd_root) || exit 1

# Source validation library
source "$DDD_ROOT/lib/validation.sh"

echo "üîç Final decision policy validation before push..."

# Process each ref being pushed
validation_errors=0
while read -r local_ref local_sha remote_ref remote_sha; do
    # Skip branch deletions
    if [[ "$local_sha" == "0000000000000000000000000000000000000000" ]]; then
        continue
    fi
    
    # Determine range start
    range_from="$remote_sha"
    if [[ "$range_from" == "0000000000000000000000000000000000000000" ]]; then
        # First push: use empty tree
        range_from="$(git hash-object -t tree /dev/null)"
    fi
    
    log_debug "Validating range $range_from..$local_sha for $local_ref"
    
    # Validate the range
    if ! validate_range_decisions "$range_from" "$local_sha"; then
        validation_errors=$((validation_errors + 1))
        log_error "Push blocked for $local_ref"
    fi
done

if [[ $validation_errors -gt 0 ]]; then
    log_error "Pre-push validation failed with $validation_errors error(s)"
    exit 1
fi

echo "‚úÖ Pre-push validation passed"